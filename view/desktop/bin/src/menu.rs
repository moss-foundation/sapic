use strum::{AsRefStr as StrumAsRefStr, Display as StrumDisplay, EnumString as StrumEnumString};
use tauri::{
    AppHandle, Manager, Runtime as TauriRuntime, Window,
    menu::{Menu, MenuEvent, PredefinedMenuItem},
};

// use crate::create_child_window;

#[derive(Debug, StrumEnumString, StrumDisplay, StrumAsRefStr)]
pub enum BuiltInMenuEvent {
    #[strum(serialize = "file.newWindow")]
    NewWindow,
    #[strum(serialize = "file.closeWindow")]
    CloseWindow,
}

pub fn handle_event<R: TauriRuntime>(_window: &Window<R>, event: &MenuEvent) {
    let event_id = event.id().0.as_str();
    let app_handle = _window.app_handle().clone();
    match event_id {
        // "file.newWindow" => handle_new_window(app_handle),
        _ => {}
    }
}

// fn handle_new_window(app_handle: tauri::AppHandle) {
//     tauri::async_runtime::spawn(async move {
//         match create_child_window(&app_handle, "/") {
//             Ok(webview_window) => {
//                 webview_window.on_menu_event(move |window, event| handle_event(window, &event));
//             }
//             Err(err) => {
//                 eprintln!("Failed to open a new window: {}", err);
//                 return;
//             }
//         }
//     });
// }

pub fn app_menu<R: TauriRuntime>(app_handle: &AppHandle<R>) -> tauri::Result<Menu<R>> {
    #[cfg(not(target_os = "macos"))]
    {
        Menu::new(app_handle)
    }

    #[cfg(target_os = "macos")]
    {
        use tauri::menu::{AboutMetadataBuilder, MenuBuilder, MenuItemBuilder, SubmenuBuilder};

        unsafe {
            macos_trampoline::set_app_name(&"Moss Studio".into());
        }

        let app_menu = SubmenuBuilder::new(app_handle, "Moss")
            .item(&PredefinedMenuItem::about(
                app_handle,
                Some("About Moss Studio"),
                Some(
                    AboutMetadataBuilder::new()
                        .license(Some(env!("CARGO_PKG_VERSION")))
                        .version(Some(env!("CARGO_PKG_VERSION")))
                        // TODO: .website(Some("https://mossland.dev/"))
                        // TODO: .website_label(Some("mossland.dev.com"))
                        .build(),
                ),
            )?)
            .separator()
            .item(&PredefinedMenuItem::hide(
                app_handle,
                Some("Hide Moss Studio"),
            )?)
            .hide_others()
            .show_all()
            .separator()
            .quit()
            .build()?;

        let window_menu = SubmenuBuilder::new(app_handle, "Window")
            .minimize()
            .item(
                &MenuItemBuilder::with_id(BuiltInMenuEvent::NewWindow, "New Window")
                    .build(app_handle)?,
            )
            .build()?;

        let menu = MenuBuilder::new(app_handle)
            .item(&app_menu)
            .item(&window_menu)
            .build()?;

        Ok(menu)
    }
}
